# AI驱动二开工作流提示词框架设计

## 适用场景

本工作流用于**持续迭代的二次开发项目**，特点：
- 同一个项目会不断添加新需求
- 每个需求都有独立的生命周期
- 需要追溯每个需求的完整历史
- 多个需求可能并行或串行开发

## 设计原则

### 1. 统一的角色体系
所有提示词共享同一个核心身份，根据阶段切换专注模式：

```
核心身份：AI项目协调专家
专注模式：
  - 探测模式：理解项目现状
  - 需求模式：澄清和定义产品需求
  - 设计模式：制定技术方案
  - 执行模式：驱动代码开发
```

### 2. 统一的输入输出规范

**输入规范**：
```yaml
上下文:
  项目状态文件: .workflow/project_state.yaml
  用户输入: string
  当前阶段: string
  历史记录: []

阶段输入:
  - 引用: 通过上下文变量
  - 格式: {{workflow.variable_name}}
```

**输出规范**：
```yaml
产出物:
  路径: .workflow/artifacts/{阶段}/{文件名}
  格式: Markdown

决策输出:
  类型: DECISION
  选项: [继续下一阶段 | 需要澄清 | 回溯修正]
  内容: 具体决策内容

澄清输出:
  类型: CLARIFY
  问题: []
  选项: []
```

### 3. 统一的交互协议

**澄清问题格式**：
```markdown
## 需要澄清的问题

### 问题1：{问题描述}
- A) 选项A
- B) 选项B
- C) 选项C

请回复：1A 或 1B 或 1C
```

**确认触发条件**：
- 输出中包含 `{{CONFIRM}}` 标记
- 产出物文件未包含 `status: confirmed` 元数据

### 4. 统一的状态管理

#### 两层状态结构

**全局项目状态**（项目级，每个项目一个）：
```yaml
# .workflow/project_state.yaml
project:
  name: string
  root_path: string
  created_at: datetime

requirements:
  - id: REQ_001
    name: "用户权限管理"
    status: completed
    created_at: datetime
    artifacts_path: .workflow/requirements/REQ_001
  - id: REQ_002
    name: "数据导出功能"
    status: in_progress
    created_at: datetime
    artifacts_path: .workflow/requirements/REQ_002

current_requirement_id: REQ_002
```

**单需求状态**（需求级，每个需求一个）：
```yaml
# .workflow/requirements/REQ_{ID}/requirement_state.yaml
requirement:
  id: REQ_001
  name: string
  description: string
  created_at: datetime
  status: drafting | clarifying | designing | planning | developing | completed | cancelled

workflow:
  current_stage: STAGE_DETECT | STAGE_REQUIRE | STAGE_DESIGN | STAGE_PLAN | STAGE_EXECUTE
  completed_stages: []
  stage_history:
    - stage: string
      timestamp: datetime
      input: string
      output: string
      status: string

artifacts:
  project_snapshot: .workflow/requirements/REQ_001/stage0_detect/project_snapshot.md
  prd: .workflow/requirements/REQ_001/stage1_require/prd.md
  tech_design: .workflow/requirements/REQ_001/stage2_design/tech_design.md
  todo_list: .workflow/requirements/REQ_001/stage3_plan/todo_list.md
  code_changes: .workflow/requirements/REQ_001/stage4_execute/changes/

pending_clarifications: []
```

## 阶段定义

| 阶段ID | 名称 | 输入 | 产出物 | 决策点 |
|--------|------|------|--------|--------|
| STAGE_DETECT | 项目探测 | 用户需求 | project_snapshot.md | 进入需求定义 |
| STAGE_REQUIRE | 需求定义 | project_snapshot + 用户需求 | prd.md | 进入设计 or 澄清 |
| STAGE_DESIGN | 技术设计 | prd.md | tech_design.md | 进入计划 or 澄清 |
| STAGE_PLAN | 开发计划 | tech_design.md | todo_list.md | 进入执行 |
| STAGE_EXECUTE | 代码开发 | todo_list项 | 代码文件 | 继续下一项 or 回溯 |

## 目录结构

```
项目根目录/
├── .workflow/
│   ├── project_state.yaml                 # 全局项目状态
│   ├── requirements/                      # 所有需求的隔离目录
│   │   ├── REQ_001_用户权限管理/
│   │   │   ├── requirement_state.yaml     # 需求状态
│   │   │   ├── stage0_detect/
│   │   │   │   └── project_snapshot.md    # 项目现状快照
│   │   │   ├── stage1_require/
│   │   │   │   └── prd.md                 # 产品需求文档
│   │   │   ├── stage2_design/
│   │   │   │   └── tech_design.md         # 技术方案设计书
│   │   │   ├── stage3_plan/
│   │   │   │   └── todo_list.md           # 开发任务清单
│   │   │   └── stage4_execute/
│   │   │       ├── changes/               # 代码变更摘要
│   │   │       └── summary.md             # 完成总结
│   │   ├── REQ_002_数据导出功能/
│   │   │   └── ...
│   │   └── REQ_XXX_需求名称/
│   │       └── ...
│   └── templates/                         # 提示词模板
│       ├── _COORDINATOR_.prompt.md
│       ├── _STAGE0_DETECT_.prompt.md
│       ├── _STAGE1_REQUIRE_.prompt.md
│       ├── _STAGE2_DESIGN_.prompt.md
│       ├── _STAGE3_PLAN_.prompt.md
│       └── _STAGE4_EXECUTE_.prompt.md
```

## 需求ID命名规范

```
REQ_{序号}_{简短名称}

示例：
- REQ_001_user_auth
- REQ_002_data_export
- REQ_003_api_optimization
```

## 多需求处理策略

### 串行开发
```
REQ_001 (completed) → REQ_002 (in_progress) → REQ_003 (pending)
```

### 并行开发（未来支持）
```
REQ_001 (completed)
├── REQ_002 (in_progress, 不冲突的模块)
└── REQ_003 (in_progress, 不冲突的模块)
```

## 提示词模板结构

```markdown
# {阶段名称}提示词

## 你是谁
[统一角色定义 + 当前专注模式]

## 当前上下文
- 项目状态：{{workflow.project_state}}
- 当前阶段：{{workflow.current_stage}}
- 用户输入：{{user_input}}

## 你的任务
[具体任务描述]

## 输入材料
{{workflow.artifacts.[上一阶段产出物]}}

## 输出要求
1. 产出物保存路径：.workflow/artifacts/{stage}/{filename}
2. 输出格式：Markdown
3. 决策输出：DECISION | CLARIFY

## 成功标准
[本阶段的完成标准]

## 注意事项
- 保持与现有项目架构的一致性
- 优先复用现有资产
- 明确标注需要用户确认的部分
```
